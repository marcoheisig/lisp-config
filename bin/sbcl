#!/bin/sh

SBCL=~/lisp/impl/sbcl

export SBCL_HOME=$SBCL/contrib

if [ `hostname` = desktop ]; then
    FASL_DIR=/tmp/fasls
else
    FASL_DIR=~/lisp/fasls
fi

dump_core() {
    $SBCL/src/runtime/sbcl \
        --core $SBCL/output/sbcl.core  \
        --userinit ~/lisp/configs/sbcl.lisp \
        --eval "(mapc 'require '(sb-bsd-sockets sb-posix sb-introspect
sb-cltl2 asdf sb-sprof closer-mop cl-ppcre cxml cxml-stp closure-html
drakma named-readtables iterate cffi trivial-garbage bordeaux-threads
chipz trivial-gray-streams conium prepl osicat command-line-arguments
cl-pdf cl-typesetting postmodern alexandria csv-parser ironclad cl-json
ht-simple-ajax hunchentoot local-time vecto simple-date cl-who cl-jpeg
salza2))" \
        --eval "(sb-ext:save-lisp-and-die \"$FASL_DIR/sbcl-core\")"
}

if [ ! -e $FASL_DIR/sbcl-core ]; then
    dump_core
fi

exec $SBCL/src/runtime/sbcl --core $FASL_DIR/sbcl-core "$@"
