#!/bin/sh

SBCL=~/lisp/impl/sbcl

export SBCL_HOME=$SBCL/contrib

dump_core() {
    $SBCL/src/runtime/sbcl \
        --core $SBCL/output/sbcl.core  \
        --userinit ~/lisp/configs/sbcl.lisp \
        --eval "(mapc 'require '(sb-bsd-sockets sb-posix sb-introspect sb-cltl2 asdf sb-sprof))" \
        --eval '(sb-ext:save-lisp-and-die (merge-pathnames "lisp/fasls/sbcl-core" (user-homedir-pathname)))'
}

if [ ! -e ~/lisp/fasls/sbcl-core ]; then
    dump_core
fi

exec $SBCL/src/runtime/sbcl --core ~/lisp/fasls/sbcl-core "$@"
